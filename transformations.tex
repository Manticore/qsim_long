% =============================================================================
\section{Specific cases of transformations}
% =============================================================================

In order to Wigner transform the master equation~\eqnref{master-eqn:master-eqn}, we will need several theorems about transformations of specific operator sequences.

First, we will need an expression for high-order commutators of restricted field operators.
They look somewhat similar to those for single-mode bosonic operators, or standard field operators from~\cite{Louisell1990}.

\begin{lemma}
	\begin{eqn*}
		\left[ \Psiop, ( \Psiop^{\prime\dagger} )^l \right]
		& = l \delta_{\restbasis} (\xvec^\prime - \xvec) ( \Psiop^{\prime\dagger} )^{l-1}, \\
		\left[ \Psiop^\dagger, ( \Psiop^\prime )^l \right]
		& = - l \delta_{\restbasis}^* (\xvec^\prime - \xvec) ( \Psiop^\prime )^{l-1}.
	\end{eqn*}
\end{lemma}
\begin{proof}
Proved by induction.
\end{proof}

A further generalisation of these relations is

\begin{lemma}
\label{lmm:func-operators:functional-commutators}
	\begin{eqn*}
		\left[ \Psiop, f( \Psiop^\prime, \Psiop^{\prime\dagger} ) \right]
		& = \delta_{\restbasis} (\xvec^\prime - \xvec) \frac{\partial f}{\partial \Psiop^{\prime\dagger}} \\
		\left[ \Psiop^\dagger, f( \Psiop^\prime, \Psiop^{\prime\dagger} ) \right]
		& = -\delta_{\restbasis}^* (\xvec^\prime - \xvec) \frac{\partial f}{\partial \Psiop^\prime},
	\end{eqn*}
	where $f(z, z^*)$ is a function that can be expanded into the power series of $z$ and $z^*$.
\end{lemma}

First theorem describes the transformation of the linear part of the Hamiltonian~\eqnref{master-eqn:hamiltonian}.

\begin{theorem}
\label{thm:transformations:w-commutator1}
    \begin{eqn*}
    	\mathcal{W} \left[ [\int d\xvec \Psiop_j^\dagger \Psiop_k, \hat{A}] \right]
    	= \int d\xvec \left(
    		- \frac{\delta}{\delta \Psi_j} \Psi_k
    		+ \frac{\delta}{\delta \Psi_k^*} \Psi_j^*
    	\right) \mathcal{W}[\hat{A}].
    \end{eqn*}
\end{theorem}
\begin{proof}
Proved straightforwardly using \thmref{func-wigner:mc-correspondences} and the relation
\begin{eqn}
	\Psi_k \frac{\delta}{\delta \Psi_j} \mathcal{F}
	= \left(
		\frac{\delta}{\delta \Psi_j} \Psi_k
		- \delta_{jk} \delta_{\restbasis}(\xvec, \xvec)
	\right) \mathcal{F}.
\end{eqn}
\end{proof}

Commutators with the Laplacian inside require somewhat special treatment, because it acts on basis functions and, in general, cannot be dragged around like a constant.
But for our purposes we only need one specific case, and, fortunately, in this case it does act like a constant.

\begin{theorem}
\label{thm:transformations:w-laplacian-commutator1}
    \begin{eqn*}
    	\mathcal{W} \left[
    		\int d\xvec [\Psiop^\dagger \nabla^2 \Psiop, \hat{A}]
    	\right]
    	= \int d\xvec \left(
    		- \frac{\delta}{\delta \Psi} \nabla^2 \Psi
    		+ \frac{\delta}{\delta \Psi^*} \nabla^2 \Psi^*
    	\right) \mathcal{W}[\hat{A}].
    \end{eqn*}
\end{theorem}
\begin{proof}
Proved using \thmref{func-wigner:mc-correspondences} and \lmmref{func-calculus:move-laplacian}.
\end{proof}

Next theorem describes the transformation of the non-linear part of the Hamiltonian.
\todo{Can be simplified by assuming the locality of the interaction, thus getting rid of $\xvec^\prime$.}

\begin{theorem}
\label{thm:transformations:w-commutator2}
    \begin{eqn*}
    	\mathcal{W} \left[
    		[
    			\int d\xvec \int d\xvec^\prime
    			\Psiop_j^\dagger \Psiop_k^{\prime\dagger} \Psiop_j^\prime \Psiop_k,
    			\hat{A}
    		]
    	\right] \\
    	= \int d\xvec \int d\xvec^\prime \left(
    		\frac{\delta}{\delta \Psi_j} \left(
    			- \Psi_j^\prime \Psi_k \Psi_k^{\prime*}
    			+ \frac{1}{2} \delta_{jk} \delta_{\restbasis}(\xvec^\prime, \xvec^\prime) \Psi_k
    			+ \frac{1}{2} \delta_{\restbasis}(\xvec, \xvec^\prime) \Psi_j^\prime
    		\right) \right . \\
    	\left. + \frac{\delta}{\delta \Psi_j^{\prime*}} \left(
    			\Psi_j^* \Psi_k \Psi_k^{\prime*}
    			- \frac{1}{2} \delta_{jk} \delta_{\restbasis}(\xvec, \xvec) \Psi_k^{\prime*}
    			- \frac{1}{2} \delta_{\restbasis}(\xvec, \xvec^\prime) \Psi_j^*
    		\right) \right. \\
    	\left. + \frac{\delta}{\delta \Psi_k^\prime} \left(
    			- \Psi_j^\prime \Psi_j^* \Psi_k
    			+ \frac{1}{2} \delta_{jk} \delta_{\restbasis}(\xvec, \xvec) \Psi_j^\prime
    			+ \frac{1}{2} \delta_{\restbasis}(\xvec^\prime, \xvec) \Psi_k
    		\right) \right .\\
    	\left. + \frac{\delta}{\delta \Psi_k^*} \left(
    			\Psi_j^\prime \Psi_j^* \Psi_k^{\prime*}
    			- \frac{1}{2} \delta_{jk} \delta_{\restbasis}(\xvec^\prime, \xvec^\prime) \Psi_j^*
    			- \frac{1}{2} \delta_{\restbasis}(\xvec^\prime, \xvec) \Psi_k^{\prime*}
    		\right) \right. \\
    	\left.
    			+ \frac{\delta}{\delta \Psi_j}
    			\frac{\delta}{\delta \Psi_j^{\prime*}}
    			\frac{\delta}{\delta \Psi_k^\prime}
    			\frac{1}{4} \Psi_k
    			- \frac{\delta}{\delta \Psi_j}
    			\frac{\delta}{\delta \Psi_j^{\prime*}}
    			\frac{\delta}{\delta \Psi_k^*}
    			\frac{1}{4} \Psi_k^{\prime*}
    		\right. \\
    	\left.
    			+ \frac{\delta}{\delta \Psi_k^\prime}
    			\frac{\delta}{\delta \Psi_k^*}
    			\frac{\delta}{\delta \Psi_j}
    			\frac{1}{4} \Psi_j^\prime
    			- \frac{\delta}{\delta \Psi_k^\prime}
    			\frac{\delta}{\delta \Psi_k^*}
    			\frac{\delta}{\delta \Psi_j^{\prime*}}
    			\frac{1}{4} \Psi_j^*
    	\right) \mathcal{W}[\hat{A}].
    \end{eqn*}
\end{theorem}
\begin{proof}
Proof is the same as in case of \thmref{transformations:w-commutator1}.
\end{proof}

Finally, the transformation of loss terms~\eqnref{master-eqn:loss-term} requires more work.
The proof makes use of two auxiliary lemmas.
First one will help us move functional differentials to their intended places (i.e., to the left).

\begin{lemma}
\label{lmm:transformations:swap-differential}
    For $\mathcal{F} \in \mathbb{F}_{\restbasis} \rightarrow \mathbb{F}$ and any non-negative integer $a$, $b$:
    \begin{eqn*}
    	\Psi^a \left( \frac{\delta}{\delta \Psi} \right)^b \mathcal{F}[\Psi, \Psi^*] \\
    	= \sum_{j=0}^{\min(a, b)}
    		\binom{b}{j} \frac{(-1)^j a!}{(a - j)!}
    		\delta_{\restbasis}(\xvec, \xvec)^j
    		\left( \frac{\delta}{\delta \Psi} \right)^{b - j}
    		\Psi^{a - j}
    		\mathcal{F}[\Psi, \Psi^*]
    \end{eqn*}
\end{lemma}
\begin{proof}
Proved straightforwardly by induction.
\end{proof}

Second lemma gives a way to simplify sums obtained from the application of the previous lemma.

\begin{lemma}[Sum rearrangement]
\label{lmm:transformations:sum-rearrangement}
    For any non-negative integer $l$, $u$:
    \begin{eqn*}
    	\sum_{j=0}^l \sum_{k=0}^{\min(l-u,j)} x^{j-k} Q(j, k)
    	= \sum_{v=0}^l x^v \sum_{k=0}^{l-\max(u,v)} Q(v + k, k).
    \end{eqn*}
\end{lemma}
\begin{proof}
Can be proved either by formal manipulation with sets, or by drawing a picture.
\end{proof}

Finally, the loss transformation theorem can be proved.

\begin{theorem}
\label{thm:transformations:w-losses}
    The Wigner transformation of loss term~\eqnref{master-eqn:loss-term} is
    \begin{eqn*}
\fl    	\mathcal{W} \left[ \int d\xvec \hat{\mathcal{L}}_{\lvec} [\hat{A}] \right]
    	= \int d\xvec
    		\sum_{j_1=0}^{l_1} \sum_{k_1=0}^{l_1} \ldots
    		\sum_{j_C=0}^{l_C} \sum_{k_C=0}^{l_C}
    			\left(
    				\prod_{c=1}^C
    					\left( \frac{\delta}{\delta \Psi_c^*} \right)^{j_c}
    					\left( \frac{\delta}{\delta \Psi_c} \right)^{k_c}
    			\right)
    			L_{\lvec, \jvec, \kvec}
    		\mathcal{W}[\hat{A}],
    \end{eqn*}
    where
    \begin{eqn*}
\fl    	L_{\lvec, \jvec, \kvec}
    	= \left( 2 - (-1)^{\sum_c j_c} - (-1)^{\sum_c k_c} \right) \\
    		\prod_{c=1}^C \left(
    			\sum_{m_c=0}^{l_c - \max(j_c, k_c)}
    			Q(l_c, j_c, k_c, m_c)
    			\delta_{\restbasis}(\xvec, \xvec)^{m_c}
    			\Psi_c^{l_c - j_c - m_c}
    			(\Psi_c^*)^{l_c - k_c - m_c}
    		\right),
    \end{eqn*}
    and
    \begin{eqn*}
        Q(l, j, k, m)
    	= (-1)^m \left( \frac{1}{2} \right)^{j + k + m}
    		\frac{(l!)^2}{m! j! k! (l - k - m)! (l - j - m)!}.
    \end{eqn*}
\end{theorem}
\begin{proof}
Proved by applying \thmref{func-wigner:mc-correspondences}, expanding products using binomial theorem, using \lmmref{transformations:swap-differential} to move differentials to front, and applying \lmmref{transformations:sum-rearrangement} to transform summations.
\end{proof}
